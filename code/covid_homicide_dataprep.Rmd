---
title: "COVID_Proj"
author: "Lily Kraus"
date: "2024-03-21"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(readr)
library(lubridate)

#Figure out which cities are reporting all 60 months in this data set by looking at was ANYTHING reported in a given month. 
covid_2018 <- read_rds("../data/nibrs_offense_segment_2018.rds")
covid_2019 <- read_rds("../data/nibrs_offense_segment_2019.rds")
covid_2020 <- read_rds("../data/nibrs_offense_segment_2020.rds")
covid_2021 <- read_rds("../data/nibrs_offense_segment_2021.rds")
covid_2022 <- read_rds("../data/nibrs_offense_segment_2022.rds")




#temp <- covid_2022 %>% filter(ucr_offense_code == "murder/nonnegligent manslaughter")

# Create a function that filters based on desired UCR offense code
filt_function <- function(data, offense_code) {
  filtered_data <- data %>% filter(ucr_offense_code == offense_code)
  return(filtered_data)
}

# Apply the filter function to each of the original data sets
filtered_covid_2018 <- filt_function(covid_2018, "murder/nonnegligent manslaughter")
rm(covid_2018)

filtered_covid_2019 <- filt_function(covid_2019, "murder/nonnegligent manslaughter")
rm(covid_2019)

filtered_covid_2020 <- filt_function(covid_2020, "murder/nonnegligent manslaughter")
rm(covid_2020)

filtered_covid_2021 <- filt_function(covid_2021, "murder/nonnegligent manslaughter")
rm(covid_2021)

filtered_covid_2022 <- filt_function(covid_2022, "murder/nonnegligent manslaughter")
rm(covid_2022)

# Read in ORI data
#FSTATE and FPLACE together are geoid!
ORI_data <- read.delim("./data/ORI_Data.tsv", header = TRUE)

library(janitor)
# Cleaning up ORI_data column names
# Adding necessary leading 0's to fstate
# F state has 2 digits
ORI_data <- ORI_data %>% janitor::clean_names() %>%
  mutate(
    fstate = as.character(ORI_data$fstate) ,
    # Add leading 0 if length is 1
    fstate_padded = ifelse(
      nchar(ORI_data$fstate) == 1,
      paste0("0", ORI_data$fstate),
      as.character(ORI_data$fstate)
    ),
    fplace = as.character(ORI_data$fplace),
    fplace_lengths = nchar(as.character(ORI_data$fplace)),
    # Adding necessary leading 0's to fplace
    # F place has  5 digits - include leading 0s
    num_zeros = ifelse(fplace_lengths < 5, 5 - fplace_lengths, 0),
    fplace_padded = paste0(strrep("0", num_zeros), fplace),
    geoid = paste0(fstate_padded, fplace_padded)
  )


# Select desired columns from ORI data
ORI_data <-
  ORI_data %>% dplyr::select(ori9, name, statename, countyname, address_city, fstate_padded, fplace_padded, geoid)

# Merging the yearly crime data with the ORI data
merged_2018 <- filtered_covid_2018 %>% left_join(ORI_data, by = c("ori" = "ori9"))
merged_2019 <- filtered_covid_2019 %>% left_join(ORI_data, by = c("ori" = "ori9"))
merged_2020 <- filtered_covid_2020 %>% left_join(ORI_data, by = c("ori" = "ori9"))
merged_2021 <- filtered_covid_2021 %>% left_join(ORI_data, by = c("ori" = "ori9"))
merged_2022 <- filtered_covid_2022 %>% left_join(ORI_data, by = c("ori" = "ori9"))

# Formatting and creating desired date-related columns
merged_2018$incident_date <- as.Date(merged_2018$incident_date)
merged_2019$incident_date <- as.Date(merged_2019$incident_date)
merged_2020$incident_date <- as.Date(merged_2020$incident_date)
merged_2021$incident_date <- as.Date(merged_2021$incident_date)
merged_2022$incident_date <- as.Date(merged_2022$incident_date)

# Create year month column
merged_2018$year_month <- format(merged_2018$incident_date, "%Y-%m")
merged_2019$year_month <- format(merged_2019$incident_date, "%Y-%m")
merged_2020$year_month <- format(merged_2020$incident_date, "%Y-%m")
merged_2021$year_month <- format(merged_2021$incident_date, "%Y-%m")
merged_2022$year_month <- format(merged_2022$incident_date, "%Y-%m")

# Create year column
merged_2018$year <- format(merged_2018$incident_date, "%Y")
merged_2019$year <- format(merged_2019$incident_date, "%Y")
merged_2020$year <- format(merged_2020$incident_date, "%Y")
merged_2021$year <- format(merged_2021$incident_date, "%Y")
merged_2022$year <- format(merged_2022$incident_date, "%Y")

# Create month column
merged_2018$month <- format(merged_2018$incident_date, "%m")
merged_2019$month <- format(merged_2019$incident_date, "%m")
merged_2020$month <- format(merged_2020$incident_date, "%m")
merged_2021$month <- format(merged_2021$incident_date, "%m")
merged_2022$month <- format(merged_2022$incident_date, "%m")

merged <- rbind(merged_2018,
                            merged_2019,
                            merged_2020,
                            merged_2021,
                            merged_2022)

save(merged, file ="./data/merged.rds")

load("./data/merged.rds")

#Group merged data by geoid
#Check that geoid is a unique city
#Some geoids have multiple cities with them?  
# ids <- merged %>% group_by(geoid,address_city) %>% summarize(n = n()) %>% ungroup() %>% group_by(geoid) %>% summarize(n = n()) %>% arrange(-n) %>% filter(n >1) %>% pull(geoid)
# merged %>% filter(geoid %in% ids) %>% group_by(geoid, address_city) %>% summarize(n = n())

merged_by_geoid <-
  merged %>% group_by(geoid, year_month) %>% summarize(
    num_murders = n(),
    address_city = head(address_city, 1),
    state = head(state_abb, 1)
  )

                                                    
#Now merge on census population data
#What else is available in the census ACS data set.  
library(tidycensus)
census_api_key("aa5ff0c4c7a7ea56db3bafe255b0ee1c6733786e")

city_pop <- 2018:2022 %>% 
  map(\(x) get_acs(geography = "place",
                   year = x,
                   survey = "acs5",
                   variables = "B01003_001"))
names(city_pop) <- 2018:2022

library(janitor)
city_pop[['2018']]$year <- 2018
for (i in 2018:2022){
  city_pop[[as.character(i)]]$year <- i
}

city_pop_stack <- bind_rows(city_pop, .id = "year") %>% 
  janitor::clean_names() %>% 
  separate(name, sep = ", ", into = c("city", "state")) %>% 
  mutate(city = str_to_lower(city),
         state = str_to_lower(state)) 

city_pop_stack$year <- as.character(city_pop_stack$year)

library(lubridate)
merged_by_geoid_with_pop <- merged_by_geoid %>% separate(year_month, into = c("year","month"), sep = "\\-") %>% left_join(city_pop_stack, by = c("geoid","year")) %>% mutate(murder_rate = 100000*num_murders/estimate)


save(merged_by_geoid_with_pop, file = "./data/merged_by_geoid_with_pop.rds")


#Aggregate by address city
merged_by_geoid_with_pop %>% group_by(year, month,address_city, state.x) %>% summarize(sum())



``` 


```{r}
merged_by_geoid_with_pop %>% group_by(year, geoid, address_city) %>% summarize(n= sum(num_murders)) %>% arrange(-n) 

merged %>% filter(address_city == "HOUSTON") %>% group_by(incident_number) %>% summarize(n=n())  %>% arrange(-n) 

merged_by_geoid_with_pop %>% group_by(year, geoid, address_city) %>% summarize(n= sum(num_murders)) %>% arrange(-n) %>% filter(geoid == 4835000)

merged_by_geoid_with_pop %>% filter(geoid == 4835000)
merged_by_geoid_with_pop %>% filter(geoid == 4899201)

merged %>% filter(address_city == "CHICAGO")

merged %>% filter(address_city == "MEMPHIS") %>% group_by(geoid) %>% summarize(n = n())

merged_by_geoid_with_pop %>% group_by(geoid, year, address_city) %>% summarize(n = n()) %>% ungroup() %>% group_by(geoid, address_city) %>% summarize(n = n()) %>% arrange(-n)

merged_by_geoid_with_pop %>% filter(geoid == 4835000) %>% ggplot(aes(x = make_date(year,month), y = num_murders)) + geom_path()
merged_by_geoid_with_pop %>% filter(geoid == 4835000) %>% arrange(year,month) %>% View()


test <- merged_by_geoid_with_pop %>% filter(geoid == 4835000) %>% arrange(year,month) %>% ungroup() %>% mutate(I_covid = ifelse(make_date(year,month) > make_date("2020","03"),1,0)) 

a <- lm(murder_rate ~ factor(month) + I_covid, data = test)
summary(a)
plot(a)
